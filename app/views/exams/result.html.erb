<%= title 'Resultado Consolidado', 
  link_to('Salvar', '#', :id => 'save_button_exam_execution'),
  link_to('Voltar', exams_path) %>

<h2 class="klazz_name_exam_execution"><%= @exam.name + ' • ' + @exam.exam_product_years.map(&:name).join(', ') + ' • ' + @exam.exam_dates.first.strftime('%d/%m/%Y') %></h2>
<% if @has_errors %>
  <p class="alert-error">Alguns alunos não constam no resultado abaixo por erro de marcação.</p>
  <p class="alert-error">Termine a resolução de pendências para retirar o resultado completo. </p>
<% end %>

<table id="results" class="display is-one-page-datatable">
  <thead>
    <tr>
      <th>RA</th>
      <th>Nome</th>
      <th>Unidade</th>
      <% @subjects.each do |subject, size| %>
        <th><%= subject.code %></th>
        <th><%= subject.code %></th>
      <% end %>
      <th>Acertos</th>
      <th>Média</th>
   </tr>
  </thead>

  <tbody>
  <% @student_exams.each_with_index do |student_exam, index| %>
    <tr>
      <td><%= "%07d" % (student_exam.student.ra || 0) %></td>
      <td><%= link_to(student_exam.student.name.split.map(&:mb_chars).map(&:capitalize).join(' '), student_exam_path(student_exam)) %></td>
      <td><%= student_exam.campus.name %></td>
      <% sum = 0 %>
      <% grades_hash = Hash[*student_exam.grades.split(',')] %>
      <% @subjects.each do |subject, size| %>
        <% sum = sum + (grades_hash[subject.code].to_f*size/10).round(0) %>
        <td><%= (grades_hash[subject.code].to_f*size/10).round(0) %></td>
        <td><%= grades_hash[subject.code] %></td>
      <% end %>
      <td><%= sum %></td>
      <td><%= (10*sum.to_f/@subjects.map{|a| a[1]}.inject(:+).to_f).round(3) %></td>
      <% if false %>
        <td><%= (grades_hash.map{|a| a[1]}.map(&:to_f).inject(:+).to_f / @subjects.map{|a| a[1]}.map(&:to_f).inject(:+)).round(3) %></td>
      <% end %>
    </tr>
  <% end %>
  </tbody>
</table>